<html>

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" src="./svgpath.js"></script>
    <script type="text/javascript" src="draw.js"></script>
    <script type="text/javascript" src="update.js"></script>
</head>

<body>
    <div style="margin:10px;">
        <svg id="red" class="draw update" width="200" height="150" style="border: 1px solid #ffaaaa;" />
        <svg id="blue" class="draw update" width="200" height="150" style="border: 1px solid #aaaaff;" />
        <br/>
        <input id="divide" class="update" type="range" min="1" value="3" max="6" step="1" />: 分割<br/>
        <input id="slide" class="update" type="range" min="0" value="1" max="5" step="1" />: スライド<br/>
        <input id="extrude" class="update" type="range" min="0" value="0" max="5" step="1" />: 引き伸ばし<br/>
        <input id="thick" class="update" type="range" min="1" value="3" max="5" step="1" />: 厚み<br/>
    </div>
    <div id="svg"></div>
    <script type="text/javascript">
        'use strict';
        (function (console, document, me, svgdiv) {
            Update.update = update;

            function update(param) {
                let divide = param.divide;
                let slide = param.slide;
                let extrude = param.extrude;
                let thick = param.thick;

                let extluded = 100 * extrude;

                let div = divide * 4;
                let angle = Math.PI * 2 / div;
                let len1 = 1;
                let len2 = 2 * Math.sin(angle / 2);
                let ang = 360 / div;
                let rot = 180 - (180 - ang) / 2;
                let bx = 200;
                let cx = bx * Math.cos(angle);
                let cy = bx * Math.sin(angle);


                let pathes = [];
                let red = SvgPath(Draw.getData('red')).scale(2).toString();
                let blue = SvgPath(Draw.getData('blue')).scale(2).toString();

                let match1List = [];
                match1List.push(SvgPath(red).rotate( 180).translate( bx,  0).toString());
                match1List.push(SvgPath(red).rotate(   0).translate(  0,  0).toString());
                let match1 = SvgPath(pathListMerge(match1List)).toString();

                let match2List = [];
                match2List.push(SvgPath(blue).rotate( 180).translate( bx,  0).toString());
                match2List.push(SvgPath(blue).rotate(   0).translate(  0,  0).toString());
                let match2 = SvgPath(pathListMerge(match2List)).scale(len2).rotate(rot).translate(bx,0).toString();

                let match3List = [];
                match3List.push(SvgPath(match1).rotate(angle).toString());
                match3List.push(SvgPath(match1).rotate(    0).toString());
                match3List.push(SvgPath(match2).rotate(    0).toString());
                let match3 = SvgPath(pathListMerge(match3List)).toString();

                let match4List = [];
                for (let ti=0;ti<thick;ti++) {
                    for (let tj=0;tj<ti+1;tj++) {
                        let xx = bx*(ti-tj) + cx*tj;
                        let yy = cy*tj;
                        match4List.push(SvgPath(match3).translate(xx,yy).toString());
                    }
                }
                let match4 = SvgPath(pathListMerge(match4List)).toString();

                let beltList = [];
                beltList.push(SvgPath(match3).translate(0,0).toString());
                for (let ti=0;ti<thick+1;ti++) {
                    let xx = bx*ti;
                    let yy = 0;
                    beltList.push(SvgPath(match3).translate( xx,yy).toString());
                    beltList.push(SvgPath(match3).translate(-xx,yy).toString());
                }
                let belt = SvgPath(pathListMerge(beltList)).toString();
                
              
                let match1list = ['<defs><g id="up">'];
                for (let mi=0;mi<divide*2+1;mi++) {
                    let rotangle = 360/div*mi;
                    match1list.push(`
                    <use xlink:href="#match1" stroke-width="3" transform="rotate(${rotangle})"/>
                    `);
                    if (mi<divide*2) {
                        match1list.push(`
                        <use xlink:href="#match4" stroke-width="3" transform="rotate(${rotangle})"/>
                        `);
                    }
                    //if (mi===0) { break; }
                }
                match1list.push('</g></defs>');
                    let svglist = 
                  [`<svg width="2000" height="2000">
                    ${defs}
                    <g transform="translate(500,400)scale(0.25)">
                    ${match1list.join('')}
                    <use xlink:href="#up" transform="translate(${extrude*(cx-200)},${extrude*cy})"/>
                    <use xlink:href="#up" transform="translate(${200*slide},0)rotate(180)"/>
                `];
                    for(let ai=0;ai<extrude;ai++) {
                       svglist.push(`<use xlink:href="#belt" transform="translate(${ai*(cx-200)},${ai*cy})"/>`); 
                    }
                    svglist.push(`</g></svg>`); 
                
                    document.querySelector('div#draw').innerHTML = svglist.join('');
              
                let path = pathListMerge(transformed);
        
                pathes.push(`<path d="${path}" fill="none" stroke="#000000" stroke-width="2"/>`);
                let svgstr = `<svg width="2000" height="2000">
                        <g transform="translate(100,100)">${pathes.join('')}</g></svg>`;

                if (!svgdiv) {
                    svgdiv = document.createElement('div');
                    me.parentElement.insertBefore(svgdiv, me.nextSibling);
                }
                svgdiv.innerHTML =  svgstr;
            }
        })(console, document, document.currentScript, null);

    </script>
</body>

</html>