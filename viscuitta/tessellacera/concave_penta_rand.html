<html>

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" src="./lib/svgpath.js"></script>
    <script type="text/javascript" src="./lib/draw.js"></script>
    <script type="text/javascript" src="./lib/update.js"></script>
    <script type="text/javascript" src="./lib/svgdownload.js"></script>
    <script type="text/javascript" src="./lib/tess.js"></script>
</head>

<body>
    <div style="margin:10px;">
        <input id="extrude" class="update" type="range" min="0" value="0" max="5" step="1" />: 引き伸ばし<br/>
        <input id="thick" class="update" type="range" min="1" value="3" max="10" step="1" />: 厚み<br/>
        <a class="download">ダウンロード</a>
        <br/>
    </div>
    <div id="svg"></div>
    <script type="text/javascript">
        'use strict';
        (function (console, document, me) {
            Update.update = update;
            function update(param) {
                let unit = 100;
                let extrude = param.extrude;
                let thick = param.thick;

                let extluded = 100 * extrude;
                let div = 6;
                let angle = Math.PI / div;
                let rot = 180/div;
                let cs = unit * Math.cos(angle);
                let sn = unit * Math.sin(angle);
                let cs2 = unit * Math.cos(angle/2);
                let sn2 = unit * Math.sin(angle/2);
                let cs3 = unit * Math.cos(3*angle/2);
                let sn3 = unit * Math.sin(3*angle/2);
                let cs4 = unit * Math.cos(5*angle/2);
                let sn4 = unit * Math.sin(5*angle/2);

                let red = `M 0,0 ${unit},0`;

                let tile = [];
                tile.push(SvgPath(red).rotate(0).translate(0, 0).toString());
                tile.push(SvgPath(red).rotate(rot).translate(0, 0).toString());
                tile.push(SvgPath(red).rotate(rot).translate(100, 0).toString());
                tile.push(SvgPath(red).rotate(0).translate(0, 0).toString());
                tile.push(SvgPath(red).rotate(2*rot).translate(cs, sn).toString());
                tile.push(SvgPath(red).rotate(4*rot).translate(cs+unit, sn).toString());

                let proto = 'tile';
                Tess.register(proto, Tess.makePath(tile,'#000000',2,'#ff0000',0.4));

                let name;
                name = 'sword';

                let first = true;
                let randList = [first];
                for (let ti = 0; ti < thick; ti++) {
                    let res = (Math.random()>0.5);
                    for (let tj = 0; tj < ti + 1; tj++) {
                        let xx = 2*cs2 * ti  + (-cs2+cs3 ) * tj;
                        let yy = (sn2+sn3) * tj;
                        if (first) {
                            Tess.placeUse(proto, [xx, yy], -15, [1, 1], name);
                            if (ti!==thick-1){
                                if (res) {
                                    Tess.placeUse(proto, [xx+(4*cs2-cs4), yy+sn4], 180-15, [1, 1], name);
                                } else {
                                    Tess.placeUse(proto, [xx+(4*cs2-cs4), yy+sn4], 45, [-1, 1], name);
                                }
                            }
                        } else {
                            Tess.placeUse(proto, [xx, yy], 180+45, [-1, 1], name);
                            if (ti!==thick-1){
                                if (res) {
                                    Tess.placeUse(proto, [xx+(4*cs2-cs4), yy+sn4], 180-15, [1, 1], name);
                                } else {
                                    Tess.placeUse(proto, [xx+(4*cs2-cs4), yy+sn4], 45, [-1, 1], name);
                                }
                            }
                        }
                    }
                    first = !res;
                    randList.push(first);
                }
                
                Tess.register(name, Tess.getUses(name));

                name = 'belt';
                for (let ti = -thick; ti < thick; ti++) {
                    let xx = 2*cs2 * ti;
                    let rand;
                    if (ti>=0) {
                        rand = randList[ti];
                    } else {
                        rand = !randList[-ti-1];
                    }
                    if (rand){
                    Tess.placeUse(proto, [xx, 0], -15, [1, 1], name);
                    Tess.placeUse(proto, [xx+(2*cs2-cs4), sn4], 45, [-1, 1], name);
                    } else {
                    Tess.placeUse(proto, [-cs4+xx+2*cs2, sn4], 180-15, [1, 1], name);
                    Tess.placeUse(proto, [xx, 0], 180+45, [-1, 1], name);
                    }
                }
                Tess.register(name, Tess.getUses(name));

                proto = 'sword';
                name = 'up';
                for (let mi = 0; mi < div; mi++) {
                    let rotangle = 180 / div * mi;
                    Tess.placeUse(proto, [0, 0], 180+rotangle, [1, 1], name);

                }
                Tess.register(name, Tess.getUses(name));
                Tess.placeUse('up', [0, 0]);
                Tess.placeUse('up', [-cs4*extrude, sn4*extrude], 180);


                for (let ai = 0; ai < extrude; ai++) {
                    Tess.placeUse('belt', [ai *(-cs4), ai * sn4]);
                }
                
                let svgstr = `<svg width="2000" height="2000">
                        <g transform="translate(400,300)scale(0.4)">${Tess.getUses()}</g></svg>`;

                Tess.svg(me, svgstr);
            }
        })(console, document, document.currentScript);
    </script>
</body>

</html>